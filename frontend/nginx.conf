worker_processes auto;
error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;

    server {
        listen       8080;
        listen       [::]:8080;
        server_name  _;         # Underscore as a catch-all

        # Root directory for static files
        root /usr/share/nginx/html;
        index index.html;

        # Hide Nginx version
        server_tokens off;

        # Load MIME types and set custom type for .webmanifest
        include mime.types;
        types {
            application/manifest+json  webmanifest;
        }

        # Gzip compression
        gzip on;
        # Compress only these MIME types (HTML is also beneficial, but be mindful of potential overhead)
        gzip_types
            text/css
            text/javascript
            text/xml
            application/javascript
            application/json
            application/xml
            image/svg+xml;

        # Optional performance directives (often set at the http block)
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;

        # Error handling
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }

        # OPTIONAL: Basic security headers (tweak as needed)
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Frame-Options SAMEORIGIN;

        # Caching for static assets with hashed filenames or rarely-changing content
        # Use an appropriate 'expires' value (e.g. 1y for hashed files).
        # If you do not use hashed filenames, reduce the duration, or remove it entirely.
        location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg|webp|ttf|otf|woff|woff2)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            try_files $uri =404;
        }

        # Make sure /index.html is served when requesting root or sub-paths
        location / {
            # If the maintenance file exists, show maintenance.html
            if (-f $document_root/maintenance.enable) {
                return 302 /maintenance.html;
            }

            try_files $uri $uri/ /index.html;
        }

        location = /maintenance.html {
            # Serve the actual maintenance page
            root /usr/share/nginx/html;
        }

        # If you use a service worker, manifest, or PWA assets, ensure theyâ€™re served properly
        # so the browser can update them as needed.
        # location /manifest.webmanifest {
        #     add_header Cache-Control "no-cache, must-revalidate";
        # }

        # Resolve DNS (useful if you proxy to other containers)
        resolver 127.0.0.11 valid=30s;

        autoindex off;  # Disable directory listing
    }
}
